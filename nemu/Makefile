#***************************************************************************************
# Copyright (c) 2014-2024 Zihao Yu, Nanjing University
#
# NEMU is licensed under Mulan PSL v2.
# You can use this software according to the terms and conditions of the Mulan PSL v2.
# You may obtain a copy of Mulan PSL v2 at:
#          http://license.coscl.org.cn/MulanPSL2
#
# THIS SOFTWARE IS PROVIDED ON AN "AS IS" BASIS, WITHOUT WARRANTIES OF ANY KIND,
# EITHER EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO NON-INFRINGEMENT,
# MERCHANTABILITY OR FIT FOR A PARTICULAR PURPOSE.
#
# See the Mulan PSL v2 for more details.
#**************************************************************************************/

# Sanity check
# 作用：检查 NEMU_HOME 路径是否指向一个有效的 NEMU 仓库
ifeq ($(wildcard $(NEMU_HOME)/src/nemu-main.c),)
  $(error NEMU_HOME=$(NEMU_HOME) is not a NEMU repo)
endif

# Include variables and rules generated by menuconfig
-include $(NEMU_HOME)/include/config/auto.conf
-include $(NEMU_HOME)/include/config/auto.conf.cmd
# 尝试包含 auto.conf 和 auto.conf.cmd 文件，这些文件包含 menuconfig 生成的配置变量和规则，-include 表示即使文件不存在也不会报错

# 变量 remove_quote：定义一个函数，用于去除字符串两端的引号,$(patsubst **pattern**, **replacement**, **text**)
remove_quote = $(patsubst "%",%,$(1))

# Extract variabls from menuconfig 从 menuconfig 配置中提取关键变量
GUEST_ISA ?= $(call remove_quote,$(CONFIG_ISA))
# 变量 GUEST_ISA：目标指令集体系结构（如 x86、riscv），默认为 CONFIG_ISA 的值（通过 remove_quote 去掉引号）
ENGINE ?= $(call remove_quote,$(CONFIG_ENGINE))
# 变量 ENGINE：NEMU 的执行引擎类型（如 interpreter、jit），默认为 CONFIG_ENGINE 的值（通过 remove_quote 去掉引号）
NAME    = $(GUEST_ISA)-nemu-$(ENGINE)
# 变量 NAME：生成的目标名称，格式为 <指令集>-nemu-<引擎>，如 riscv-nemu-interpreter

# Include all filelist.mk to merge file lists 指令作用：包含所有 filelist.mk 文件，这些文件中通常定义了源文件和目录列表
FILELIST_MK = $(shell find -L ./src -name "filelist.mk")
include $(FILELIST_MK)

# Filter out directories and files in blacklist to obtain the final set of source files 过滤掉黑名单中的目录和文件，生成最终的源文件列表
DIRS-BLACKLIST-y += $(DIRS-BLACKLIST)
# 变量 DIRS-BLACKLIST-y：黑名单目录列表，追加 DIRS-BLACKLIST 中的内容
SRCS-BLACKLIST-y += $(SRCS-BLACKLIST) $(shell find -L $(DIRS-BLACKLIST-y) -name "*.c")
# 变量 SRCS-BLACKLIST-y：黑名单源文件列表，包含 SRCS-BLACKLIST 和黑名单目录中的所有 .c 文件
SRCS-y += $(shell find -L $(DIRS-y) -name "*.c")
# 变量 SRCS-y：源文件列表，包含 DIRS-y 目录中的所有 .c 文件
SRCS = $(filter-out $(SRCS-BLACKLIST-y),$(SRCS-y))
# 变量 SRCS：最终的源文件列表，从 SRCS-y 中过滤掉 SRCS-BLACKLIST-y 中的文件

# Extract compiler and options from menuconfig 从 menuconfig 配置中提取编译器和编译选项
ifneq ($(CONFIG_CC),)
CC = $(call remove_quote,$(CONFIG_CC))
# 变量 CC：编译器命令（如 gcc、clang），从 CONFIG_CC 中获取（通过 remove_quote 去掉引号）
endif
CFLAGS_BUILD += $(call remove_quote,$(CONFIG_CC_OPT))
# 变量 CFLAGS_BUILD：编译器优化选项，从 CONFIG_CC_OPT 中获取（通过 remove_quote 去掉引号）
CFLAGS_BUILD += $(if $(CONFIG_CC_LTO),-flto,)
# 作用：如果 CONFIG_CC_LTO 启用，添加 -flto 选项以支持链接时优化
CFLAGS_BUILD += $(if $(CONFIG_CC_DEBUG),-Og -ggdb3,)
# 作用：如果 CONFIG_CC_DEBUG 启用，添加 -Og -ggdb3 选项以支持调试优化和详细调试信息
CFLAGS_BUILD += $(if $(CONFIG_CC_ASAN),-fsanitize=address,)
# 作用：如果 CONFIG_CC_ASAN 启用，添加 -fsanitize=address 选项以启用地址消毒器
CFLAGS_TRACE += -DITRACE_COND=$(if $(CONFIG_ITRACE_COND),$(call remove_quote,$(CONFIG_ITRACE_COND)),true)
# 变量 CFLAGS_TRACE：跟踪指令的条件，定义 ITRACE_COND 宏，默认为 true 或 CONFIG_ITRACE_COND 的值（通过 remove_quote 去掉引号）
CFLAGS  += $(CFLAGS_BUILD) $(CFLAGS_TRACE) -D__GUEST_ISA__=$(GUEST_ISA)
# 变量 CFLAGS：最终的编译器标志，包含 CFLAGS_BUILD、CFLAGS_TRACE 和目标指令集宏 __GUEST_ISA__   
LDFLAGS += $(CFLAGS_BUILD)
# 变量 LDFLAGS：链接器标志，包含 CFLAGS_BUILD 中的优化选项

# Include rules for menuconfig 包含 menuconfig 的构建规则
include $(NEMU_HOME)/scripts/config.mk

ifdef CONFIG_TARGET_AM
include $(AM_HOME)/Makefile
LINKAGE += $(ARCHIVES)
else
# Include rules to build NEMU
include $(NEMU_HOME)/scripts/native.mk
endif
